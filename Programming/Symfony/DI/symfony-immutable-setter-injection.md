
# Инъекция зависимостей неизменяемым сеттером

**Ключи**:
- Обратные:
	- [Symfony framework](Symfony-framework);
	- [Компонент внедрения зависимостей](symfony-di);

**Хештеги:** 
- #Programming/Symfony/DI;

## Реализация

Другой возможный вариант внедрения — использовать метод, который возвращает отдельный экземпляр путем клонирования исходного сервиса. Этот подход позволяет сделать сервис неизменяемым.

```php
// src/Mail/NewsletterManager.php
namespace App\Mail;

// ...
use Symfony\Component\Mailer\MailerInterface;
use Symfony\Contracts\Service\Attribute\Required;

class NewsletterManager
{
    private MailerInterface $mailer;

    /**
     * @return static
     */
    #[Required]
    public function withMailer(MailerInterface $mailer): self
    {
        $new = clone $this;
        $new->mailer = $mailer;

        return $new;
    }

    // ...
}
```

Чтобы использовать этот тип инъекции, не забудьте его настроить:

```yaml
# config/services.yaml
services:
     # ...

     app.newsletter_manager:
         class: App\Mail\NewsletterManager
         calls:
             - withMailer: !returns_clone ['@mailer']
```

Если вы решите использовать автоматическое подключение, для этого типа внедрения потребуется добавить докблок`@return static` или `static` тип возвращаемого значения, чтобы контейнер мог зарегистрировать метод.

## Преимущества

Этот подход полезен, если вам нужно настроить службу в соответствии с вашими потребностями, поэтому вот преимущества неизменяемых установщиков:

- неизменяемые установщики работают с необязательными зависимостями, поэтому, если вам не нужна зависимость, установщик не нужно вызывать;
- как и при внедрении в конструктор, использование неизменяемых установщиков заставляет зависимость оставаться неизменной в течение всего срока службы службы.
- этот тип внедрения хорошо работает с трейтами, поскольку сервис можно составить, таким образом легче адаптировать сервис к требованиям вашего приложения.
- метод установки можно вызывать несколько раз, таким образом добавление зависимости в коллекцию становится проще и позволяет добавлять переменное количество зависимостей.

## Недостатки

- Поскольку вызов установщика не является обязательным, зависимость может иметь значение null при вызове методов службы. Прежде чем использовать зависимость, необходимо убедиться, что она доступна.
- Если служба не объявлена ​​ленивой, она несовместима со службами, которые ссылаются друг на друга в так называемых циклических зависимостях.
