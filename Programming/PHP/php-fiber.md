# Файберы

**Связи:**
- Обратные
	- [PHP](PHP);

**Хештеги:** #Programming/PHP

# Определение

**Файберы** - прерываемые функции полного цикла. Файберы могут быть приостановлены из любого места цикла, приостанавливая выполнение в файбере до тех пор, пока файбер не будет возобновлён в будущем.

Файберы приостанавливают весь цикл выполнения, поэтому вызывающему функцию напрямую не нужно менять способ её вызова.

Выполнение может быть прервано в любом месте цикла с помощью метода `Fiber::suspend()` (то есть вызов `Fiber::suspend()` может находиться в глубоко вложенной функции или даже вообще не существовать).

В отличие от генераторов (Generator) без стека, у каждого объекта Fiber есть свой собственный стек вызовов, позволяющий приостанавливать их внутри глубоко вложенных вызовов функций. Функция, объявляющая точку прерывания (то есть вызов метода `Fiber::suspend()`), не должна изменять свой возвращаемый тип, в отличие от функции, использующей `yield`, который должен возвращать экземпляр Generator.

Файберы могут быть приостановлены при вызове любой функции, включая те, которые вызываются из виртуальной машины PHP, например, функции, предоставляемые `array_map()`, или методы, вызываемые `foreach` для объекта Iterator.

После приостановки выполнение файбера может быть возобновлено с любым значением с помощью метода `Fiber::resume()` или путём передачи исключения в файбер с помощью `Fiber::throw()`. Значение возвращается (или выбрасывается исключение) из метода `Fiber::suspend()`.

## Особенности

- появились в php-8.1;
- представляют собой корутыны;
- используются для реализации многозадачности;
- упрощают разработку асинхронного кода.

Корутины - блоки кода, которые работают асинхронно (т.е. поочередно). В нужный момент исполнение такого блока приостанавливается, его состояние сохраняется (включая стек вызовов). Когда к блоку возвращается управление, он продолжает работу.

## Цель

Файбер это низкоуровневый механизм, на основе которого можно построить конструкции аналогичные `async await` или `Promise`, но в php. Их не рекомендуют для использования в клиентском коде, лучше использовать уже готовые библиотеки (ReactPHP, Framework X).

## Файберы vs очереди

Когда выгоднее использовать асинхронный код, чем очереди:
- оперативное взаимодействие с API;
- несложная микросервисная архитектура;

Когда выгоднее использовать очереди:
- параллельная обработка данных;
- сложная гетерогенная архитектура;
- необходимость в отказоустойчивости;
- необходимость в управляемом масштабировании.



