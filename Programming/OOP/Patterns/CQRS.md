
# Command and Query Responsibility Segregation (CQRS)


Паттерн, позволяющий разделить опреации чтения и записи для хранилищ данных.
Подробнее на сайте майкрософт - [здесь](https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs)

## Преимущества

- Производительность (Perfomance);
- Масштабируемость (Scalability);
- Удобство разработки (Convenience).

Все это достигается следующим образом:

1) Существует две модели, одна на чтение (Query), другая на запись (Command)
2) Для записи может использоваться реляционная БД, для чтения любая другая БД (или несколько БД)
3) В БД для чтения хранятся заранее подготовленные, денормализованные, отфильтрованные представления. Когда у нас есть достаточно много логики с фильтрацией и агрегацией, мы можем заранее  вычислять необходимые значения и сохранять их в материализованном представлении, чтобы использовать заранее подготовленные данные для выборки. 

![[Pasted image 20221106200012.png]]

## Принципы

1) Существуют комманды и запросы;
2) Комманды (Command) - некоторые задачи, сценарии, юзкейсы и не должны возвращать ничего, кроме результатов своей работы (ошибки либо идентификаторы созданной сущности)
3) Запросы должны возвращать DTO и не должны производить никаких сайдэффектов

## Реализация в Symfony

Для реализации в Symfony используются мессенджер и коммандные шины (Bus).

1) Создадим две шины, одну для комманд, другую для запросов
2) Обе шины синхронные. Комманды могут быть асинхронными, но тогда они не должны возвращать каких либо значений

![[Pasted image 20221106200606.png]]

Пример:

1) Есть некоторая комманда - создать пользователя
2) Комманда будет содержать 2 свойства - email и password
3) Команда приходит POST запросом от API (Application layer), создается ДТО
4) DTO сериализуется через коммандную шину (в Sender) и синхронно реализуется обработка
5) Комманда подхватывает хендлер и запускает скрипт создания пользователя и записи в БД

При работе с запросом происходит то же самое но в результате в хендлере мы получаем ДТО пользователя и отправляем его в приложение.

**Ключи:**
- [CQRS Symfony](CQRS-Symfony);
- [ООП паттерны](OOP-patterns) 

**Хештеги:** #Programming/OOP/Patterns




