
# Протокол AMQP 0-9-1

**Связи:**
- Обратные
	- [Брокеры сообщений](queue-broker);
- Прямые:
	- [RabbitMQ](rabbit-mq.md);
	- [Apache Kafka](apache-kafka.md);
	- [Справочник протокола](https://www.rabbitmq.com/amqp-0-9-1-reference)

**Хештеги:** #Queue/Protocol 

## Общие сведения

Является синхронным протоколом, т.е. протоколом, который не дает возможности отправить следующий запрос пока не получен ответ на предыдущий. Они страдают от headline blocking, когда один медленный запрос тормозит всё соединение.

Для решения этой проблемы в AMQP есть каналы. Это виртуальные соединения внутри одного физического. Они являются единицей параллелизма, но не являются thread saved сами по себе, поэтому один и тот же канал не может быть использован в разных потоками.

Основные сущности:
- Connection - TCP соединение;
- Channel - виртуальное соединение для экономии ресурсов;
- Exchange - точка приема сообщений (точка обмена);
- Queue - хранилище сообщений;
- Binding - связи между Exchange и Queue (маршрутизация).

Принципы:
- в каналах работает 2-way RPC;
- ошибка по умолчанию закрывает канал;
- чем меньше соединений, тем лучше (один Connection с несколькими Channel эффективнее).

Method frame - структруа с которой начинается передача данных. Она состоит из команд (лучше уточнить):
- Basic;
- Publish;
- Exchange name;
- Routing key;
- Mandatory flag.

Header frame - структура с заголовками (cpntent-type, message-id, delivery-mode, reply-to и пр.), дополнительные данные, специфичные для работы очередей данные

Data frame - полезная нагрузка, тело с данными, может передавать в теории до 2 GB, 127 Mb передает практически, может содержать и бинарные данные.

## Методы

AMQP 0-9-1 структурирован как несколько методов. Методы представляют собой операции (например, методы HTTP) и не имеют ничего общего с методами объектно-ориентированных языков программирования. Методы протокола в AMQP 0-9-1 сгруппированы в классы. Классы — это просто логические группы методов AMQP. Справочник AMQP 0-9-1 содержит полную информацию обо всех методах AMQP.

Давайте взглянем на класс точки обмена — группу методов, связанных с операциями на точках обмена. Он включает в себя следующие операции:

- `exchange.declare`
- `exchange.declare-ok`
- `exchange.delete`
- `exchange.delete-ok`

Вышеуказанные операции образуют логические пары: `exchange.declare` и `exchange.declare-ok`, `exchange.delete` и `exchange.delete-ok`. Этими операциями являются «запросы» (отправленные клиентами) и «ответы» (отправленные брокерами в ответ на вышеупомянутые «запросы»). Например, издатель/читатель использует `exchange.declare` для объявления новой точки обмена, а брокер в ответ отправляет `exchange.declare-ok`, при успешном создании.

Не все методы протокола имеют пары (counterparts). Некоторые не имеют соответсвующего ответа, в то время как другие имеют несколько вариаций ответа.

## Соединения

Соединения AMQP 0-9-1 обычно долговечны. AMQP 0-9-1 — это протокол уровня приложения, который использует TCP для надежной доставки. Соединения используют аутентификацию и могут быть защищены с помощью TLS. Когда приложению больше не требуется подключение к серверу, оно должно корректно закрыть соединение AMQP 0-9-1 вместо резкого закрытия основного TCP-соединения.

## Каналлы

Некоторые приложения требуют множетсвенных соединений с брокером. Однако, одновременно держать открытыми множетсво TCP соединений нежелательно, потому что это требует системных ресурсов и делает сложным настройку фаерволов (брандмауэров). Соединения AMQP 0-9-1 мультиплексированны с каналами, которые могут восприниматься как "легковесные соединения, которые делят одно основное соединение".

Каждая операция протокола выполняемая клиентом происходит в канале. Взаимодействие на определенном канале полностью отделено от взаимодействий на других каналах. Но каждый метод протокола, обрабатывает так же и ID канала (он же номер канала). Это число, используемое как клиентом, так и брокером для распознания к каком каналу применяется метод.

Канал существует только в контексте соединения и никогда сам по себе. Когда соединение закрывается, закрываются и все каналы на нем.

Для приложений, которые используют несколько потоков/процессов для обработки, очень часто открывают новый канал для каждого потока/процесса и не используют общие каналы между ними.




