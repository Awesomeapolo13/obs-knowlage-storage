
# Точка обмена (Exchange)

**Связи:**
- Обратные
	- [RabbitMQ](rabbit-mq.md);
- Прямые:
	- [Привязки](rabbit-bindings);

**Хештеги:**
- #Queue/Broker ;
- #Rabbit/Exchange

## Общие сведения

**Точка обмена (обменник)** - это именованная таблицы маршрутизации. Записи таблицы называются *привязками* (bindings).

**Точки обмена** — это объекты протокола AMQP 0-9-1, куда отправляются сообщения. Они принимают сообщение и направляют его в ноль или более очередей. Используемый алгоритм маршрутизации зависит от типа точки обмена и правил, называемых привязками. Брокеры AMQP 0-9-1 предоставляют четыре типа обмена. Так же отдельно можно выделить тип *Consistent Hashing*, применяемый через соответствующий плагин.

Помимо типа точки обмена, они объявляются с рядом атрибутов, наиболее важными из которых являются:

- Name (Наименование);
- Durability (Долговечность - точки обмена переживают перезапуск брокера);
- Авто-удаление (точка обмена удаляется, когда последняя очередь отвязывается от неё);
- Аргументы (опционально, используется плагинами и специфическими фичами брокера).

Точки обмена могут быть длительными (durable) или временными (transient). Долговременные точки обмена выдерживают перезапуск брокера, тогда как временные — нет (их необходимо повторно объявить, когда брокер возвращается в режим онлайн). Не все сценарии и варианты использования требуют, чтобы точки обмена были долговечными.

## Точка обмена по умолчанию

Точка обмена по умолчанию - это точка типа *Direct* без имени (пустая строка) предопределенного брокером сообщений. Она имеет одну особенность, которая делает её полезной для маленьких приложений: *каждаю вновь созданная очередь автоматически привязывается к ней с ключем маршрутизации (routing key) соответствующем имени этой очереди*.

Точка обмена по умолчанию в RabbitMQ не позволяет выполнять операции привязки/отвязки. Операции привязки к точке обмена по умолчанию приведут к ошибке.

## Типы точек обмена

Ниже приведены виды точек обмена, встроенные в реббит "из коробки" (за исключением последней). Существуют и другие типы точек обмена, предоставляемые через плагины.

1) **Fanout Exchange** - разветвление. Сообщения копируются во все точки обмена и очереди, привязанные к точке обмена. Ключ маршрутизации игнорируется. Т.е. когда новое сообщение попадает в разветвленную точку обмена, копия сообщения отправляется на все очереди, к котормы она привязана.

	Способы использования такой точки обмена:
	- массовые многопользовательские онлайн-игры (MMO) могут использовать его для обновления таблицы лидеров или других глобальных событий;
	- сайты спортивных новостей могут использовать разветвленные точки обмена для распространения обновлений счета среди мобильных клиентов практически в режиме реального времени;
	- распределенные системы могут транслировать различные обновления состояния и конфигурации;
	- групповые чаты могут распределять сообщения между участниками с помощью разветвленного обмена (хотя AMQP не имеет встроенной концепции присутствия, поэтому XMPP может быть лучшим выбором).

	Основная killer фича rabbit - диспетчеризация, т.е. мы хотим точно указать какие сообщения в какие очереди могут попасть, а какие нет. Это достигается благодаря протоколу AMQP. Мы добавляем сообщению некие метаданные, например, *ключ маршрутизации* (`routing_key`). Есть несколько вариантов бизнес-логики, для обработки ключа маршрутизации.

2) **Direct Exchange** - прямая связь. Маршрутизация по точному соотетствию ключа маршрутизации (`routing_key`). Т.е. с сообщением передаем ключ маршрутизации, и далее сообщение пропускается в те очереди, где совпадают эти ключи. Например, указать в ключе тип новости. Одна очередь, может принимать несколько разных ключей маршрутизации.

3) **Topic Exchange**  - тематическая. Аналог Direct с проверкой на частичное соответствие ключа маршрутизации. Т.е. отправляет сообщения в очереди, чей ключ маршрутихации подходит под некоторый паттерн. Точно знает что-то про внутреннюю структуру ключа маршрутизации. Ключ разделяется точками `LEVEL.AppName` (`LEVEL` - уровень логирования). При этом в плейсхолдерах `*` - одно слово, `#` - любое количество слов (`*.ECommerceSite.WebUI`, `ERROR.#`, `#` - слушает всё). Часто используется для многоадресной (multicast) маршрутизации сообщений

![[Pasted image 20240617125657.png]]

Лучше в конце ключа указывать `#`, чтобы предусмотреть дальнейшее развитие ключа на несколько уровней ниже. Единственный побочный эффект, мы возможно будем получать несколько больше сообщений, но это лучше чем совсем не получить их при использовании `*`.
	Примеры использования:
	- распространение данных, относящихся к конкретному географическому местоположению, например, точкам продаж;
	- обработка фоновых задач, выполняемая несколькими работниками, каждый из которых способен обрабатывать определенный набор задач;
	- обновления цен на акции (и обновления других видов финансовых данных);
	- обновления новостей, которые включают категоризацию или маркировку (например, только для определенного вида спорта или команды);
	- оркестрация сервисов разного типа в облаке;
	- сборки или пакеты программного обеспечения с распределенной архитектурой/ОС, в которых каждый сборщик может работать только с одной архитектурой или ОС.

4) **Header Exchange** - заголовочный. К сообщениям добавляются заголовки получателей, требуется точное соответствие заголовков. (самый гибкий и самый медленный)

	Заголовлчный тип точки обмена предназначен для маршрутизации по множеству атрибутов, которые легче выразить в виде заголовков сообщений, чем в виде ключа маршрутизации. Обмен заголовками игнорирует атрибут ключа маршрутизации. Вместо этого атрибуты, используемые для маршрутизации, берутся из атрибута заголовков. Сообщение считается совпадающим, если значение заголовка равно значению, указанному при привязке. 
	
	Можно привязать очередь к точке обмена, используя для сопоставления более одного заголовка. В этом случае брокеру требуется еще информация от разработчика приложения, а именно, следует ли ему рассматривать сообщения с совпадающим любым из заголовков или со всеми? Для этого и нужен аргумент привязки «x-match». Если для аргумента «x-match» установлено значение «any», достаточно только одного соответствующего значения заголовка. Альтернативно, установка для параметра «x-match» значения «all» означает, что все значения должны совпадать.
	
	Для «any» и «all» заголовки, начинающиеся со строки x-, не будут использоваться для оценки совпадений. Установка для параметра «x-match» значения «any-with-x» или «all-with-x» также будет использовать заголовки, начинающиеся со строки x-, для оценки совпадений.
	
	Заголовочные точки обмена можно рассматривать как «direct exchange на стероидах». Поскольку они маршрутизируются на основе значений заголовка, их можно использовать в качестве direct exchange, где ключ маршрутизации не обязательно должен быть строкой; например, это может быть целое число или хэш (словарь).

5) **Consistent Hashing** - консистентное хэширование. Очередь выбирается по хэшу. Используется через плагин к RebbitMQ. Используется для решения проблемы конкурирующих консюмеров и последовательностей обработки сообщений.


