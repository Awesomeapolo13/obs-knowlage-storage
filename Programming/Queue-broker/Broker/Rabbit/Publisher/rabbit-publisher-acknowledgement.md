
# Подтверждения публикации

**Связи:**
- Обратные
	- [RabbitMQ](rabbit-mq.md);
	- [Доставка сообщений](rabbit-messaging);
- Прямые:

**Хештеги:**
- #Queue/Broker ;
- #Rabbit/Publisher 

## Стратегии для подтверждения публикации сообщений

Подтверждения издателя (Publisher confirms) -  механизм для разработчиков приложений, который позоляет отслеживать, какие сообщения были успешно приняты RabbitMQ. Существует несколько часто используемых стратегий использования подтверждений издателя:

- публикация сообщений по отдельности с использованием потоковых подтверждений (асинхронные элементы API: обработчики событий подтверждения, фьючерсы/промисы и т. д.);
- публикация пакета сообщений и ожидание подтверждений обо всех невыполненных сообщениях;
- публикация сообщений по отдельности с ожиданием подтверждения, при этом мы не публикуем следующее сообщение, пока не получим подтверждение от текущего. Этот вариант крайне не рекомендуется из-за его сильно негативного влияния на пропускную способность издателя.

Все варианты различаются по производительности и простоте использования.

## Потоковые подтвердения

Большинство клиентских библиотек дают разработчикам возможность получать индивидуальные подтверждения, как только они приходят от сервера. Потоковые подтверждения (Streaming Confirms) будут приходить асинхронно. Поскольку публикация сообщений асинхронна, эта опция обеспечивает безопасную публикацию с минимальными накладными расходами. Алгоритм обычно такой:

- установить подтверждения издателей на каналл;
- для каждого публикуемого сообщения добавить запись на карте (entry map), которая сопоставляется с текущим порядковым номером сообщения;
- при получении положительного отклика удалить эту запись;
- при негативном подтверждении, так же удаляем запись, но отправляем это сообщение для повторной отправки (или предусматриваем иное поведение).

## Пакетная публикация

При этой стратегии происходит публикация сообщений пакетами и ожидание подтверждений от всей партии. Повторные попытки выполняются так же пакетами.

- Включить подтверждение издателя на канале.
- Для каждого опубликованного пакета сообщений дождитесь всех невыполненных подтверждений.
- Когда все подтверждения окажутся положительными, опубликуйте следующую партию.
- При наличии отрицательных подтверждений или превышений времени ожидания повторно опубликуйте весь пакет или только соответствующие сообщения.

Некоторые клиенты предоставляют удобные элементы API для ожидания всех подтверждений. Например, в клиенте Java есть Channel#waitForConfirms(timeout).

Поскольку этот подход предполагает ожидание подтверждений, он окажет негативное влияние на пропускную способность издателя. Чем больше партия, тем меньше будет эффект.

## Публикация с ожиданием

Эту стратегию можно считать анти-паттерном и она задукументирована исключительно ради полноты картины. Она вызывает публикацию сообщения и немедленное ожидание подтверждения о получении. Она схожа со стратегией пакетной публикации, если бы в каждом пакете было лишь одно сообщение.

Этот подход будет иметь очень существуенное негативное влияние на пропускную способность.

