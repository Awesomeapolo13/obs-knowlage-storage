# RabbitMQ cluster

**Связи:**
- Обратные
	- [RabbitMQ](rabbit-mq.md);
- Прямые:

**Хештеги:**
- #Queue/Broker ;
- #Rabbit 

## Кластер

Возможность создавать кластер встроена в реббит.

![[Pasted image 20240618110658.png]]

Появляется несколько экземпляров реббита. Каждый из них является репликой всех остальных экземпляров, с точки зрения их внутренних связей, но при этом там есть внешние связи, которые формируются между узлами (нодами).

Publusher может отправлять сообщения на одну ноду, но читать их консьюмер можен совсем с другой ноды. То есть нет необходимости читать и писать в один и тот же экземпляр ребита, что позволяет расщивать сетевые каналы.

### Особенности

1) Для клиентов это выглядит как один брокер.
2) Все ноды общаются со всеми. Т.е. при создании новой точки обмена в одной ноде, они создаются во всех остальных нодах.
3) Топология кластера не поддается конфигурированию.
4) Все ноды должны использовать совместимые версии RabbitMQ и Erlang. Т.е. нельзя сделать поэтапное обновление в кластере (одну ноду обновили, потом другую и т.д.).
5) Это гарантирует C и P из CAP-теоремы

### Типы нод в кластере

Типы это просто флажки которые можно устанавливать для нод.

1) RAM nodes

2) Disk nodes - хранят данные на диске и могут восстановить структуру ребита (как правило их делают две, чтобы в случае отказа одной, другая копия структуры другой осталась на диске)

3) Stats nodes - нужны чтобы сбрасывать статистику по самому реббиту.

## Публикация с подтверждением

![[Pasted image 20240618145917.png]]

1) Сообщение публикуется в node1 внутри кластера.
2) В node2 есть аналгичная node1 точка обмена, подписанная на node1.
3) Из node2 сообщение попадает в очередь (в зависимости от стратегии запишется на диск).
4) node2 отвечает node1, что все ок.
5) node1 ответит паблишеру что все ок.

## Преимущества и недостатки

Преимущества:
- high availability - можно читать в несколько потоков с меньшими накладными расходами;
- прозрачность для клиентов - для них ничего не меняется, они ходят к кластеру как к обычному брокеру.

Недостатки:
- обязательная, надежная и быстрая сеть (защита от brain split) - иначе будет просадка производительности во время обмена между нодами;
- оверхед и скорость работы пропорциональны размеру кластера.