
# События в node.js

Event Emmiter необходим, чтобы обмениваться событиями между частями нашей системы. С одной стороны мы можем подписаться на событие, с другой - его генерить. При генерации передаются данные, для их обработки в обработчике этого события.

## Отличия

### Event Emitter

- Берется из модуля events;
- Несколько listener на 1 события;
- Эмулирует почти всю EE API;
- Обработка ошщибок через  error (это событие);
- Встроенные события add / remove listeners.

### Event Target

- Глобальная переменная;
- Только 1 listener для события;
- Частичная эмуляция;
- Нет обработки через error;
- Нет события добавления и удаления обработчиков.

## Использование

1) Подключаем EventEmmiter из стандартной библиотеки и определяем его.

```js
const EventEmmiter = require('events');

const myEventEmmiter = new EventEmmiter();
```

2) Добавляем слушателя событий. Для этого создадим функцию, чтобы передать ее в слушатель и имя соббытия.

```js
const logDbConnection = () => {
	console.log('DB connected');
};

myEventEmmiter.addListener('connected', )
```

3) Теперь надо заэммитить в наш эмитер. Эмитеров может быть много, но нужно это делать именно в тот, с помощью которого создали слушатель. Первым аргементом передаем имя события, далее можно передать неограниченное количество аргументов.

```js
myEventEmmiter.emit('connected');
```

4) Чтобы не затрачивать слишком много памяти на слушатели событий (утечка увент листенера), необходимо их удалять.

```js
// Удаляет все лисенеры. Передаем только имя события.
myEventEmmiter.removeAllListeners('connected');

// Удаляет конкрентный лисенер. Передаем событие и имя его обработчика
myEventEmmiter.removeListener('connected', logDbConnection);

// Отключает лисенер от события. Передаем событие и имя его обработчика
myEventEmmiter.off('connected', logDbConnection);
```

5) Так же можно добавлять подписчиков и события.

```js
// Подписались на событие 'msg', приэтом ожидаем получение некоторых данных data
myEventEmmiter.on('msg', (data) => {
	console.log(`Получил: ${data}`);
});

// При вызове обработчика передаем данные
myEventEmmiter.emit('msg', 'Привет, вот мое сообщение!');
```

6) Можно подписаться не на каждое событие, а лишь на одно. То есть после получения первого события наш эмитер будет удален.

```js
// Подписались на событие 'off', после срабатываения события удалиться.
myEventEmmiter.once('off', () => {
	console.log(`Вызвался один раз.`);
});

// При вызове обработчика передаем данные
myEventEmmiter.emit('off');
```

7) Слушатели событий могут создаваться в любых частях кода и любых количествах. Их количество необходимо контролировать. Например, можно задать предельное количество слушателей, при превышении котороого, мы будем получать Warning.

```js
// Ограничиваем эммитеру количество слушателей.
myEventEmmiter.setMaxListeners(1);

//По умолчанию max количество слушателей = 10. Но это можно уточнить
myEventEmmiter.getMaxListeners();
// Так же можно посмотреть и количество слушателей на конкретном событии
myEventEmmiter.listenerCount('msg');
```

!! Количество слушателей на событии зависит от того, каким способом они были добавлены и в какой момент в коде была вызвана функция получения их количества. Т.е. если мы подписались функцией `once`, то после вызова обработчика их количество станет 0.

Так же можно получить массив слушателей события. Порядок слушателей в массиве определяется порядком их добавления в коде.

```js
myEventEmmiter.listeners('msg');
```

8) Если необходимо строго задать порядок выполнения слушателей в массиве, то используются `prependListener` и `appendListener`

```js
myEventEmmiter.on('msg', () => {});
myEventEmmiter.prependListener('msg', () => {});
```

В примере выше сначала выполнится `prepend` и только затем `on`.

## Обработка ошибок

Для создания ошибки необходимо вызвать событие `'error'`. Даже при отсутствии обработчика, вызов этого события вызовек ошибку в скрипте.

```js
myEventEmmiter.emit('error')
```

Для обработки ошибок необходимо создать обработчик события `error`.

```js
myEventEmmiter.on('error', (err) => {
	console.log('Произршла ошибка!!');
})
```

Тогда вместо ошибки выведется сообщение из обработчика.

**Ключи:**
- [Программирование](PROGRAMMING);
- [JS](javascript);
- [Node.js](node-js);

**Хештеги:** #Programming/JS/NodeJs