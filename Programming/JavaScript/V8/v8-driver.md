
# Движок V8

Движок V8 - виртуальная машина, которая выполняет Javascript, т.е. некий движок, который позволяет нам преобразовать наш код в bytecode  и машинный код, чтобы его выполнить.

Данный движок получил свое имя от восьмицилендрового ДВС и разрабатывается компанией Google. Внедрен в браузер Chrome и Node.js.

## Уровни представления кода

![[Pasted image 20230219192538.png]]

1) Есть JS код, который пишет некий разработчик;
2) Далее этот код преобразуется в абстрактное синтаксическое дерево AST, это позволяет эффективнее обходить его и рабирать его синтаксис;
3) AST преобразуется в Byte Code (называется так, потому что каждый элемент нашего кода занимает 1 байт);
4) Byte Code превращается в Машинный код, эффективно исполняемый нашим компьютером.

## AST

Программа представляется деревом операций. По этому дереву движок понимает, что было написано.

![[Pasted image 20230219204311.png]]

## ByteCode

Byte Code - набор инструкций, который говорит, что необходимо сделать.

![[Pasted image 20230219204519.png]]

## Компиляторы

Рассматривается архитерктура движка на момент августа 2021 года.

![[Pasted image 20230219204948.png]]

Исходный код, с помощью парсера, преобразовывается в AST. Далее Ignition может интерпретировать наше AST в ByteCode. Затем ByteCode имеет две опции. Если мы можем его оптимизировать, то он отправляется в компилятор Turbofan, если же нет - в  компилятор Sparkplug (вышел в версии движка 9.1).

Что означает "может оптимизироваться"? Пример: некоторая функция умножения повторяется в коде несколько раз в разных местах. Тогда V8 будет оптимизировать её, поскольку в неё всегда ожидают числа, они всегда умножабтся и пр. Т.е. за счет предсказуемости входящих типов V8 оптимизирует этот кусок кода.

Turbofan преобразует ByteCode в Оптимизированный машинный код, Sparkplug - в Неоптимизированный машинный код (за один проход, но технически пока за два - авторы движка планируют оставить один проход).

После передачи кода в Turbofan, компилятор проверяет можно ли оптимизировать данный код. Если он находит, что в качестве аргумента в функцию может быть переданно не только число (как пример), то он отправит код в Sparkplug. Этот процесс называется Деоптимизацией.

## Hidden class, как работает деоптимизация

Когда Turbofan делает предположения, он создает Hidden class, который потом исползуется чтобы понимать типы передаваемых объектов. Hidden class не имеет ничего общего с нашими реальными классами.

Если вы будете передавать в функцию один и тот же объект, но в какой-то момент передадите тот же объект с дополнительным свойством (например, не объявленным в конструкторе), то для компилятра это означает, что вы передали другой тип, что свалит код в деоптимизацию.

## Вывод

Для написания оптимизированного кода на JS необходимо:
1) Сохранять тип данных переданных в функцию.
2) Сохранять порядок свойств в объекте.

**Ключи:**
- [JS](javascript);
- [Node.js](node-js);

**Хештеги:** #Programming/JS/NodeJs/V8