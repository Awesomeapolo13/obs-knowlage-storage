
# Внешний ключ

**Ключи:**
- Обратные:
	- [MySQL](MySQL);
	- [Ограничения](mysql-constraints);
- Прямые:

**Хештеги:** #Programming/Databases/MySQL/Constraints 

## Определение

**Внешний ключ** — это столбец или группа столбцов в таблице, который ссылается на столбец или группу столбцов в другой таблице. Внешний ключ накладывает ограничения на данные в связанных таблицах, что позволяет MySQL поддерживать ссылочную целостность.

Обычно столбцы внешнего ключа дочерней таблицы часто ссылаются на столбцы первичного ключа родительской таблицы.

Таблица может иметь более одного внешнего ключа, причем каждый внешний ключ ссылается на первичный ключ разных родительских таблиц.

После установки ограничения внешнего ключа столбцы внешнего ключа дочерней таблицы должны иметь соответствующую строку в столбцах родительского ключа родительской таблицы, или значения в этих столбцах внешнего ключа должны быть NULL.

Иногда дочерняя и родительская таблицы могут ссылаться на одну и ту же таблицу. В этом случае внешний ключ ссылается на первичный ключ в той же таблице.
## Синтаксис

Вот основной синтаксис определения ограничения внешнего ключа в операторе `CREATE TABLE` или `ALTER TABLE`:

```sql
[CONSTRAINT constraint_name]
FOREIGN KEY [foreign_key_name] (column_name, ...)
REFERENCES parent_table(colunm_name,...)
[ON DELETE reference_option]
[ON UPDATE reference_option]
```

Сначала указывается имя ограничения внешнего ключа, который мы пытаемся создаеть, после ключевого слова `CONSTRAINT`. Если опустить имя ограничения, MySQL автоматически сгенерирует имя для ограничения внешнего ключа.

Во-вторых, указывается список столбцов внешнего ключа, разделенных запятыми, после ключевых слов `FOREIGN KEY`. Имя внешнего ключа также не является обязательным и генерируется автоматически, если его пропустить.

В-третьих, указывается родительская таблица, за которой следует список столбцов, разделенных запятыми, на которые ссылаются столбцы внешнего ключа.

Наконец, укажите, как внешний ключ поддерживает ссылочную целостность между дочерней и родительской таблицами, используя предложения `ON DELETE` и `ON UPDATE`. Параметр `reference_option` определяет действие, которое MySQL предпримет, когда значения в столбцах родительского ключа будут удалены (`ON DELETE`) или обновлены (`ON UPDATE`).

MySQL имеет пять эталонных опций: `CASCADE`, `SET NULL`, `NO ACTION`, `RESTRICT` и `SET DEFAULT`:
- `CASCADE` - если строка из родительской таблицы удаляется или обновляется, значения соответствующих строк в дочерней таблице автоматически удаляются или обновляются;
- `SET NULL` - если строка из родительской таблицы удалена или обновлена, значения столбца (или столбцов) внешнего ключа в дочерней таблице устанавливаются в `NULL`;
- `RESTRICT` - если строка из родительской таблицы имеет соответствующую строку в дочерней таблице, MySQL отклоняет удаление или обновление строк в родительской таблице;
- `NO ACTION` - то же самое, что и `RESTRICT`;
- `SET DEFAULT` - распознается парсером MySQL. Однако это действие отклоняется таблицами InnoDB и NDB.

MySQL полностью поддерживает три действия: `RESTRICT`, `CASCADE` и `SET NULL`.

Если вы не укажете предложения `ON DELETE` и `ON UPDATE`, действием по умолчанию будет `RESTRICT`.

## Удаление внешнего ключа

Чтобы удалить ограничение внешнего ключа:

```sql
ALTER TABLE table_name 
DROP FOREIGN KEY constraint_name;
```
- `table_name` - имя таблицы, которой принадлежит внешний ключ;
- `constraint_name` - имя ограничения;

Чтобы посмотреть сгенерированное имя ограничения внешнего ключа по таблице, можно использовать выражение ниже (оно просто показывает весь запрос создания таблицы `table_name`):

```sql
SHOW CREATE TABLE table_name;
```

## Отключение проверки внешнего ключа

Иногда очень полезно отключить проверку внешнего ключа, например, когда необходимо выполнить импорт данных из файла CSV в таблицу. Иначе, придется загружать данные в правильном порядке, т. е. придется сначала загружать данные в родительские таблицы, а затем в дочерние таблицы, что может быть утомительно. Однако при отключении проверки внешнего ключа, можно загружать данные в таблицы в любом порядке.

```sql
SET foreign_key_checks = 0;
```

Включить проверку на внешние ключи `foreign_key_checks` нужно установить в статус `1`.
