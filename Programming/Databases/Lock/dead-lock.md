
# Deadlock

**Ключи:**
- Обратные:
	- [Базы данных](db-lock);
- Прямые:
	- [MySQL deadlock](mysql-dead-lock);
	- [PostgreSQL deadlock](postgres-dead-lock)

**Хештеги:** #Programming/Databases/Lock

## Определение

**Дедлок** (или взаимная блокировка) — это ситуация, когда две или более транзакции ждут друг друга, чтобы освободить ресурсы, и, как следствие, ни одна из них не может продолжить работу. Можно представить два поезда, которые встретились на одноколейном пути: один не может двигаться вперед, пока другой не освободит путь, и наоборот.

## Пример

Представим, что у нас есть две транзакции:

1. **Транзакция A**:
    
    - Блокирует ресурс 1.
    - Ждет ресурс 2.

2. **Транзакция B**:
    
    - Блокирует ресурс 2.
    - Ждет ресурс 1.

Обе транзакции теперь заблокированы, и ни одна из них не может завершиться, так как они ждут друг друга.

## Обнаружение дедлока

Существует несколько способов борьбы с дедлоками:

1. **Избегание дедлоков**:
    
    - **Упорядочивание доступа к ресурсам**: если все транзакции запрашивают ресурсы в одном и том же порядке, вероятность дедлока снижается.
    - **Минимизация времени удержания блокировок**: старайся выполнять как можно меньше операций под блокировками и отпускать блокировки как можно быстрее.
    - **Разделять задачи:** разбивать сложные транзакции на несколько простых.
    - **Использовать оптимистические блокировки**.

2. **Обнаружение и устранение дедлоков**:
    
    - PostgreSQL автоматически обнаруживает дедлоки и убивает одну из транзакций для разрыва взаимной блокировки. Это позволяет другой транзакции завершиться, а убитая транзакция может быть повторена.
    - MySQL так же способна обнаружить дедлок самостоятельно и убить одну из транзакций;
    - Для повторения транзакции при таких ошибках, нужно предусмотреть обработку (на стороне приложения);