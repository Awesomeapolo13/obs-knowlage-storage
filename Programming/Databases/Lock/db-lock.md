
# Блокировки БД

**Ключи:**
- Обратные:
	- [Базы данных](databases);
- Прямые:
	- [Deadlock](dead-lock);

**Хештеги:** #Programming/Databases/Lock

## Определение

Блокировки в БД - это механизм, который используется для управления параллельным доступом к данным, чтобы избежать проблем, таких как противоречивые обновления.

## Виды блокировок по субъекту блокировки

1) Блокировка строк (Row-Level Locks).

Эти блокировки применяются к отдельным строкам таблицы. Это самый тонкий и часто используемый тип блокировок, который позволяет множеству транзакций работать с разными строками одной и той же таблицы одновременно.

```sql
BEGIN;
SELECT * FROM my_table WHERE id = 1 FOR UPDATE;
-- Здесь строка с id = 1 будет заблокирована для обновлений другими транзакциями
COMMIT;
```

2) Блокировка таблиц (Table-Level Locks).

Эти блокировки применяются ко всей таблице и используются, когда необходимо гарантировать, что ни одна другая транзакция не сможет модифицировать данные в этой таблице до завершения текущей транзакции.

```sql
BEGIN;
LOCK TABLE my_table IN EXCLUSIVE MODE;
-- Здесь вся таблица my_table будет заблокирована для других операций записи
COMMIT;
```

3) Блокировка страниц (Page-Level Locks).

Эти блокировки применяются к конкретным страницам данных или индексов в базе данных. Страница - это единица хранения данных, обычно 8KB. Page-Level Locks менее распространены, так как большинство СУБД предпочитают использовать блокировки на уровне строк или таблиц.

4) Блокировка баз данных (Database-Level Locks).

Эти блокировки применяются ко всей базе данных и используются крайне редко, обычно для административных задач.

## Типы блокировок

Типы блокировок зависят от БД.

1) **SHARED LOCK (S)**
	- позволяет читать данные, но не изменять их;
	- несколько транзакций могут одновременно держать SHARE-блокировку на одной и той же строке или таблице.
2) **EXCLUSIVE LOCK (X)**
	- блокирует чтение и запись данных;
	- только одна транзакция может держать EXCLUSIVE-блокировку на строке или таблице в любое время.
3)  **UPDATE LOCK (U)**
	- Позволяет другим транзакциям читать данные;
	- Не позволяет другим транзакциям устанавливать UPDATE или EXCLUSIVE LOCK;
	- Позволяет инициатору впоследствии повысить до EXCLUSIVE LOCK для изменения данных;
	- Предотвращает потенциальные deadlock ситуации.
4) **SHARE ROW EXCLUSIVE (SRX)**
	- позволяет другим транзакциям держать SHARE-блокировки, но блокирует EXCLUSIVE-блокировки.
5) **ACCESS EXCLUSIVE**
	- блокирует все другие виды блокировок, используется для операций, изменяющих структуру таблицы (например, `ALTER TABLE`).